<div class="page" style="position:relative;min-height:100vh;">
    <header class="header">
      <h1>Timesheet Entry</h1>
    </header>
  
    <!-- Chart container -->
    <div id="chartContainer" style="display:flex;align-items:flex-end;width:100%;gap:8px;">
      <div style="flex:1;">
        <div id="topBarChart" style="display:flex;height:60px;width:100%;background:#eee;border-radius:4px;overflow:hidden;"></div>
        <div id="barScale" style="display:flex;justify-content:space-between;margin-top:4px;font-size:12px;color:#333;">
          <span>0m</span><span>120m</span><span>240m</span><span>360m</span><span>480m</span>
        </div>
      </div>
      <div id="totalTime" style="width:100px;height:60px;display:flex;align-items:center;justify-content:center;font-weight:bold;">0h 0m</div>
    </div>
  
    <div style="height:10px"></div>
    <h2 style="display:flex;align-items:center;gap:8px;">
      <label for="entryDate">Timesheets for</label>
      <input type="date" id="entryDate" value="2025-05-02" />
    </h2>
  
    <div id="rowContainer"></div>
  
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
      <button type="button" id="addRowBtn">Add Row</button>
      <button type="button" id="submitEntriesBtn" disabled>Submit Entries</button>
    </div>
  
    <template id="rowTemplate">
      <div class="timesheet-row" style="border:2px solid #7e97ac;border-radius:2px;padding:8px;margin-bottom:8px;display:flex;gap:8px;">
        <div class="color-swatch" style="width:20px;align-self:stretch;border-radius:4px;background:#ccc;"></div>
        <div class="selectors" style="display:flex;flex-direction:column;gap:4px;">
          <select class="task-select">
            <option value="">-- Select task (optional) --</option>
            <option value="2631">2631 - m2 - final review and publish</option>
            <option value="2650">2650 - m3 - final review and publish</option>
            <option value="2652">2652 - m4 - draft 1 storyboard internal review</option>
            <option value="2869">2869 - m1 - final review and publish</option>
          </select>
          <select class="billing-code">
            <option value="">-- Select billing code --</option>
            <option value="KIPP_FY25_TTT_design">KIPP FY25 TTT → design</option>
            <option value="EL_2025_Curriculum">EL 2025 → 2025 Curriculum</option>
            <option value="ST_2025_DCI_0702">ST 2025 → DCI Mini-Course (0702)</option>
            <option value="add-new">+ Add new billing code</option>
          </select>
          <select class="sprint-code" disabled>
            <option value="">-- Select sprint --</option>
          </select>
        </div>
        <div class="notes" style="flex:1;">
          <textarea class="notes-entry" rows="3" style="width:100%;"></textarea>
        </div>
        <div class="time-stack" style="display:flex;flex-direction:column;align-items:center;gap:4px;">
          <input type="range" class="time-slider" min="0" max="480" />
          <input type="number" class="minutes-input" min="0" max="480" placeholder="# minutes" />
          <span class="time-display">0h 0m</span>
          <label><input type="checkbox" class="row-done" disabled /> Done</label>
        </div>
      </div>
    </template>
  
    <div id="submitModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;">
      <div style="background:#fff;padding:16px;border-radius:4px;max-width:320px;width:100%;">
        <h3>Confirm Submission</h3>
        <p>Do you affirm these entries are correct and accurate?</p>
        <label><input type="checkbox" id="affirmCheckbox"> I affirm</label>
        <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
          <button type="button" id="confirmSubmitBtn" disabled>Confirm Submit</button>
          <button type="button" id="cancelSubmitBtn">Cancel</button>
        </div>
      </div>
    </div>
  
    <script>
      const addRowBtn = document.getElementById('addRowBtn');
      const rowContainer = document.getElementById('rowContainer');
      const rowTemplate = document.getElementById('rowTemplate');
      const topBar = document.getElementById('topBarChart');
      const totalTimeEl = document.getElementById('totalTime');
      const submitBtn = document.getElementById('submitEntriesBtn');
      const DAY_MAX = 480;
      const COLOR_MAP = {
        'KIPP_FY25_TTT_design': '#7e97ac',
        'EL_2025_Curriculum': '#a09382',
        'ST_2025_DCI_0702': '#8c6e63'
      };
      const SPRINT_MAP = {
        'KIPP_FY25_TTT_design': ['SPR-01', 'SPR-02'],
        'EL_2025_Curriculum': ['SPR-10', 'SPR-11'],
        'ST_2025_DCI_0702': ['SPR-20']
      };
  
      function refreshTopBar() {
        topBar.innerHTML = '';
        let totalMinutes = 0;
        rowContainer.querySelectorAll('.timesheet-row').forEach(row => {
          const cb = row.querySelector('.row-done');
          if (cb.checked) {
            const minutes = Number(row.querySelector('.minutes-input').value) || 0;
            totalMinutes += minutes;
            const pct = (minutes / DAY_MAX) * 100;
            const billingVal = row.querySelector('.billing-code').value;
            const color = COLOR_MAP[billingVal] || '#7e97ac';
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            const seg = document.createElement('div');
            seg.style.flex = `0 0 ${pct}%`;
            seg.style.background = color;
            seg.style.display = 'flex';
            seg.style.alignItems = 'center';
            seg.style.justifyContent = 'center';
            seg.style.color = '#fff';
            seg.textContent = `${h}h ${m}m`;
            topBar.appendChild(seg);
          }
        });
        const hTotal = Math.floor(totalMinutes / 60);
        const mTotal = totalMinutes % 60;
        totalTimeEl.textContent = `${hTotal}h ${mTotal}m`;
        submitBtn.disabled = totalMinutes === 0;
      }
  
      addRowBtn.addEventListener('click', () => {
        const clone = rowTemplate.content.cloneNode(true);
        const taskSelect = clone.querySelector('.task-select');
        const billingSelect = clone.querySelector('.billing-code');
        const sprintSelect = clone.querySelector('.sprint-code');
        const notesField = clone.querySelector('.notes-entry');
        const slider = clone.querySelector('.time-slider');
        const minutesInput = clone.querySelector('.minutes-input');
        const display = clone.querySelector('.time-display');
        const doneCheckbox = clone.querySelector('.row-done');
        const swatch = clone.querySelector('.color-swatch');
  
        doneCheckbox.disabled = true;
        function validateRow() {
          const taskVal = taskSelect.value;
          const billVal = billingSelect.value && billingSelect.value !== 'add-new';
          const sprintVal = sprintSelect.value;
          const minutes = Number(minutesInput.value) || 0;
          const hasNotes = notesField.value.trim() !== '';
          const valid = (taskVal || (billVal && sprintVal)) && minutes > 0 && hasNotes;
          doneCheckbox.disabled = !valid;
        }
  
        function updateDisplay(value) {
          const h = Math.floor(value / 60);
          const m = value % 60;
          display.textContent = `${h}h ${m}m`;
        }
  
        taskSelect.addEventListener('change', () => {
          const taskVal = taskSelect.value;
          billingSelect.disabled = !!taskVal;
          sprintSelect.disabled = !!taskVal;
          validateRow();
        });
        billingSelect.addEventListener('change', () => {
          taskSelect.disabled = billingSelect.value;
          const options = SPRINT_MAP[billingSelect.value] || [];
          sprintSelect.innerHTML = options.map(s => `<option value="${s}">${s}</option>`).join('');
          sprintSelect.disabled = options.length === 0;
          const color = COLOR_MAP[billingSelect.value] || '#ccc';
          swatch.style.background = color;
          validateRow();
        });
        sprintSelect.addEventListener('change', () => {
          taskSelect.disabled = sprintSelect.value;
          billingSelect.disabled = sprintSelect.value;
          validateRow();
        });
        notesField.addEventListener('input', validateRow);
        slider.addEventListener('input', () => {
          const val = Number(slider.value);
          minutesInput.value = val;
          updateDisplay(val);
          validateRow();
        });
        minutesInput.addEventListener('input', () => {
          const val = Number(minutesInput.value) || 0;
          slider.value = val;
          updateDisplay(val);
          validateRow();
        });
  
        doneCheckbox.addEventListener('change', refreshTopBar);
        rowContainer.appendChild(clone);
      });
  
      const submitModal = document.getElementById('submitModal');
      const affirmCheckbox = document.getElementById('affirmCheckbox');
      const confirmSubmitBtn = document.getElementById('confirmSubmitBtn');
      const cancelSubmitBtn = document.getElementById('cancelSubmitBtn');
  
      submitBtn.addEventListener('click', () => submitModal.style.display = 'flex');
      affirmCheckbox.addEventListener('change', () => confirmSubmitBtn.disabled = !affirmCheckbox.checked);
      cancelSubmitBtn.addEventListener('click', () => {
        affirmCheckbox.checked = false;
        confirmSubmitBtn.disabled = true;
        submitModal.style.display = 'none';
      });
      confirmSubmitBtn.addEventListener('click', () => {
        submitModal.style.display = 'none';
        alert('Entries submitted!');
      });
    </script>
  </div>
  